CREATE TABLE matches (
    match_id SERIAL PRIMARY KEY,
    player1_username VARCHAR(50) NOT NULL,
    player2_username VARCHAR(50) NOT NULL,
    match_state VARCHAR(20) NOT NULL,
    start_time TIMESTAMP NULL,
    end_time TIMESTAMP NULL,
    winner_username VARCHAR(50) NULL,
    accepted BOOLEAN NULL
);

ALTER TABLE matches
    ADD CONSTRAINT fk_player1 FOREIGN KEY (player1_username) REFERENCES players(username) ON DELETE CASCADE;

ALTER TABLE matches
    ADD CONSTRAINT fk_player2 FOREIGN KEY (player2_username) REFERENCES players(username) ON DELETE CASCADE;

ALTER TABLE matches
    ADD CONSTRAINT fk_winner FOREIGN KEY (winner_username) REFERENCES players(username);

ALTER TABLE matches
    ADD CONSTRAINT match_state_check CHECK (match_state IN ('not_started', 'on_going', 'done'));

ALTER TABLE matches
    ADD CONSTRAINT players_different CHECK (player1_username <> player2_username);

ALTER TABLE matches
    ADD CONSTRAINT winner_valid CHECK (
        winner_username IS NULL OR
        winner_username = player1_username OR
        winner_username = player2_username
    );